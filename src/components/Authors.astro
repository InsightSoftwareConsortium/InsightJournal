---
// SPDX-License-Identifier: MIT
// SPDX-FileCopyrightText: 2025 Fideus Labs LLC

/**
 * Authors component for MyST frontmatter
 * Displays authors with ORCID/email links and affiliation references
 * Props:
 * - authors: Array of Contributor objects from frontmatter
 * - affiliations: Array of Affiliation objects from frontmatter (optional, for compatibility)
 */
import type { Contributor, Name, Affiliation } from '@awesome-myst/myst-zod';

interface Props {
  authors?: Contributor[];
  affiliations?: Affiliation[];
}

const { authors, affiliations } = Astro.props;

// Helper function to capitalize the first letter of a name part
function capitalizeNamePart(namePart: string): string {
  if (!namePart || namePart.length === 0) return namePart;
  return namePart.charAt(0).toUpperCase() + namePart.slice(1).toLowerCase();
}

// Helper function to format and capitalize an author name
// Handles "Last, First" format by converting to "First Last"
function formatAuthorName(name: string): string {
  if (!name || name.length === 0) return name;
  
  // Check if name is in "Last, First" format (contains comma)
  if (name.includes(',')) {
    const parts = name.split(',').map(p => p.trim());
    if (parts.length === 2) {
      // Reverse to "First Last" format
      const firstName = parts[1];
      const lastName = parts[0];
      const formattedFirst = firstName
        .split(/\s+/)
        .map(p => capitalizeNamePart(p))
        .join(' ');
      const formattedLast = lastName
        .split(/\s+/)
        .map(p => capitalizeNamePart(p))
        .join(' ');
      return `${formattedFirst} ${formattedLast}`;
    }
  }
  
  // Otherwise, just capitalize each word part
  return name
    .split(/\s+/)
    .map(part => capitalizeNamePart(part))
    .join(' ');
}

// Helper function to get author name as string with proper formatting and capitalization
function getAuthorName(author: Contributor): string {
  if (!author.name) return 'Unknown Author';

  if (typeof author.name === 'object' && typeof author.name.given === 'string' && typeof author.name.family === 'string') {
    const parts: string[] = [];
    // Capitalize each name part properly
    if (author.name.given) parts.push(capitalizeNamePart(author.name.given));
    if (author.name.family) parts.push(capitalizeNamePart(author.name.family));
    if (parts.length > 0) return parts.join(' ');
  }
  // If name is a string, format and capitalize it
  if (typeof author.name === 'string') {
    return formatAuthorName(author.name);
  }
  // If name is an object, use the literal property and format
  if (typeof author.name === 'object' && author.name.literal) {
    return formatAuthorName(author.name.literal);
  }
  return 'Unknown Author';
}

// Build unique affiliations map with indices
// Affiliations come directly from the authors array as strings
const uniqueAffiliations = new Map<string, number>();
if (authors) {
  authors.forEach(author => {
    if (author.affiliations && Array.isArray(author.affiliations)) {
      author.affiliations.forEach((affiliation: any) => {
        // Handle both string affiliations and object affiliations
        const affiliationStr = typeof affiliation === 'string' ? affiliation : affiliation.name || affiliation.institution;
        // Trim whitespace and only add non-empty affiliations
        const trimmedAffiliation = affiliationStr?.trim();
        if (trimmedAffiliation && !uniqueAffiliations.has(trimmedAffiliation)) {
          uniqueAffiliations.set(trimmedAffiliation, uniqueAffiliations.size + 1);
        }
      });
    }
  });
}
---

{authors && authors.length > 0 && (
  <div style="margin-bottom: var(--wa-space-l);">
    <!-- Authors line -->
    <div style="margin-bottom: var(--wa-space-xs); line-height: var(--wa-line-height-normal); color: var(--wa-color-text-normal);">
      {authors.map((author: Contributor, index: number) => (
        <span>
          <span style="font-weight: var(--wa-font-weight-semibold); font-size: var(--wa-font-size-m); color: var(--wa-color-text-loud);">
            {getAuthorName(author)}
          </span>
          {/* Superscript with affiliation numbers and asterisk for corresponding author */}
          {((author.affiliations && author.affiliations.length > 0 && uniqueAffiliations.size > 0) || author.corresponding) && (
            <sup style="font-size: var(--wa-font-size-xs); margin-left: 2px; color: var(--wa-color-text-normal);">
              {author.affiliations && uniqueAffiliations.size > 0 && author.affiliations.map((affiliation: any, affIndex: number) => {
                const affiliationStr = typeof affiliation === 'string' ? affiliation : affiliation.name || affiliation.institution;
                const trimmedAffiliation = affiliationStr?.trim();
                // Only render if the trimmed affiliation exists in our map
                if (trimmedAffiliation && uniqueAffiliations.has(trimmedAffiliation)) {
                  return (
                    <span>
                      {uniqueAffiliations.get(trimmedAffiliation)}
                      {affIndex < author.affiliations.length - 1 && ','}
                    </span>
                  );
                }
                return null;
              })}
              {author.corresponding && <span>*</span>}
            </sup>
          )}
          {author.orcid && (
            <a
              href={`https://orcid.org/${author.orcid.replace(/(https?:\/\/)?orcid\.org\//, '')}`}
              target="_blank"
              rel="noopener noreferrer"
              title="ORCID"
              style="color: var(--wa-color-text-quiet); transition: color 0.2s; margin-left: var(--wa-space-2xs); text-decoration: none;"
              onmouseover="this.style.color='var(--wa-color-success-600)'"
              onmouseout="this.style.color='var(--wa-color-text-quiet)'"
            >
              <wa-icon library="scienceicons" name="orcid" style="font-size: 0.875rem; vertical-align: middle;" />
            </a>
          )}
          {author.email && (
            <a
              href={`mailto:${author.email}`}
              title="Email"
              style="color: var(--wa-color-text-quiet); transition: color 0.2s; margin-left: var(--wa-space-2xs); text-decoration: none;"
              onmouseover="this.style.color='var(--wa-color-primary-600)'"
              onmouseout="this.style.color='var(--wa-color-text-quiet)'"
            >
              <wa-icon library="scienceicons" name="email" style="font-size: 0.875rem; vertical-align: middle;" />
            </a>
          )}
          {index < authors.length - 1 && <span style="margin-right: var(--wa-space-xs);">,</span>}
        </span>
      ))}
    </div>

    <!-- Affiliations list -->
    {uniqueAffiliations.size > 0 && (
      <div style="font-size: var(--wa-font-size-s); color: var(--wa-color-text-quiet); line-height: var(--wa-line-height-normal); margin-top: var(--wa-space-s);">
        {Array.from(uniqueAffiliations.entries()).map(([affiliationName, index]) => (
          <div style="margin-bottom: var(--wa-space-2xs);">
            <span style="margin-right: var(--wa-space-xs);">{index}.</span>
            <span>{affiliationName}</span>
          </div>
        ))}
      </div>
    )}
  </div>
)}

<script>
  // Web Awesome icons are loaded globally
  // Import Web Awesome components
  import '@awesome.me/webawesome/dist/components/icon/icon.js';
  import { registerScienceIconsLibrary } from '@awesome-myst/myst-awesome/lib/wa-scienceicons.ts';

  // Register scienceicons library
  // The library files are in /public/scienceicons/
  if (typeof window !== 'undefined') {
    // Register scienceicons library manually
    customElements.whenDefined('wa-icon').then(() => {
      const iconRegistry = (window as any).waIconLibraries || {};
      if (!iconRegistry.scienceicons) {
        registerScienceIconsLibrary();
      }
    });
  }
</script>
